<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Pausenverwaltung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            color-scheme: light;
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            --brand-primary: #1671ff;
            --brand-primary-dark: #0f54c4;
            --brand-success: #2f9e44;
            --brand-danger: #d64545;
            --surface: #ffffff;
            --surface-muted: #f4f6fb;
            --border: #d8deec;
            --text: #1a1c24;
            --text-muted: #596178;
            --shadow: 0 18px 40px -24px rgba(22, 113, 255, 0.45);
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(150deg, #eef3ff 0%, #f9fbff 50%, #f4f7fb 100%);
            color: var(--text);
        }

        .page {
            max-width: 1100px;
            margin: 0 auto;
            padding: 3.5rem 1.5rem 3rem;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
        }

        .page-header h1 {
            margin: 0;
            font-size: clamp(1.9rem, 2.5vw, 2.55rem);
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .page-header .subtitle {
            margin: 0.35rem 0 0;
            color: var(--text-muted);
            font-size: 1rem;
        }

        .api-badge {
            background: rgba(22, 113, 255, 0.08);
            color: var(--brand-primary);
            border: 1px solid rgba(22, 113, 255, 0.18);
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .layout {
            margin-top: 2.25rem;
            display: grid;
            gap: 1.5rem;
        }

        .panel {
            background: var(--surface);
            border-radius: 18px;
            padding: 1.85rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(216, 222, 236, 0.55);
        }

        .panel h2 {
            margin: 0 0 1rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem 1.25rem;
            align-items: end;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
            font-size: 0.82rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .field input {
            height: 2.8rem;
            padding: 0 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            font-size: 0.98rem;
            background: var(--surface-muted);
            color: var(--text);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .field input:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(22, 113, 255, 0.15);
            background: #fff;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            border-radius: 12px;
            padding: 0.65rem 1.15rem;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
        }

        .btn svg {
            width: 18px;
            height: 18px;
        }

        .btn-primary {
            background: var(--brand-primary);
            color: #fff;
            box-shadow: 0 14px 28px -16px rgba(22, 113, 255, 0.7);
        }

        .btn-primary:hover {
            background: var(--brand-primary-dark);
            transform: translateY(-1px);
        }

        .btn-muted {
            background: rgba(89, 97, 120, 0.12);
            color: var(--text);
        }

        .btn-muted:hover {
            background: rgba(89, 97, 120, 0.2);
        }

        .btn-danger {
            background: rgba(214, 69, 69, 0.12);
            color: var(--brand-danger);
        }

        .btn-danger:hover {
            background: rgba(214, 69, 69, 0.2);
        }

        .message-area {
            margin-top: 1.35rem;
            min-height: 3rem;
        }

        .alert {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            padding: 0.9rem 1.05rem;
            border-radius: 12px;
            border: 1px solid transparent;
            background: rgba(22, 113, 255, 0.12);
            color: var(--brand-primary);
            font-weight: 500;
            animation: fade-in 0.18s ease;
        }

        .alert button {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
        }

        .alert-success {
            background: rgba(47, 158, 68, 0.1);
            border-color: rgba(47, 158, 68, 0.2);
            color: var(--brand-success);
        }

        .alert-error {
            background: rgba(214, 69, 69, 0.12);
            border-color: rgba(214, 69, 69, 0.24);
            color: var(--brand-danger);
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .status-line {
            font-size: 0.92rem;
            color: var(--text-muted);
        }

        .table-container {
            margin-top: 1rem;
            overflow: hidden;
            border-radius: 14px;
            border: 1px solid rgba(216, 222, 236, 0.6);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }

        thead {
            background: rgba(22, 113, 255, 0.08);
        }

        th {
            text-align: left;
            padding: 1rem;
            font-size: 0.82rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        td {
            padding: 0.85rem 1rem;
            border-top: 1px solid rgba(216, 222, 236, 0.6);
            vertical-align: middle;
        }

        tbody tr:hover {
            background: rgba(22, 113, 255, 0.04);
        }

        tbody tr.is-active {
            background: rgba(22, 113, 255, 0.12);
            box-shadow: inset 3px 0 0 rgba(22, 113, 255, 0.5);
        }

        tbody tr.has-error {
            background: rgba(214, 69, 69, 0.08);
        }

        td input {
            width: 100%;
            height: 2.45rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 0 0.75rem;
            background: var(--surface-muted);
            font-size: 0.95rem;
            transition: border-color 0.2s ease, background 0.2s ease;
        }

        td input:focus {
            outline: none;
            border-color: var(--brand-primary);
            background: #fff;
            box-shadow: 0 0 0 2px rgba(22, 113, 255, 0.15);
        }

        tbody tr.has-error input {
            border-color: rgba(214, 69, 69, 0.8);
            background: rgba(214, 69, 69, 0.12);
        }

        .actions {
            display: inline-flex;
            flex-wrap: wrap;
            gap: 0.45rem;
        }

        .revisions-panel {
            position: relative;
        }

        .revisions-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.2rem;
        }

        .revisions-header h2 {
            margin-bottom: 0.25rem;
        }

        .revisions-meta {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .timeline {
            margin: 1.6rem 0 0;
            padding: 0;
            list-style: none;
            position: relative;
        }

        .timeline::before {
            content: "";
            position: absolute;
            inset: 0 auto 0 12px;
            width: 2px;
            background: rgba(22, 113, 255, 0.18);
        }

        .timeline-item {
            padding-left: 2.8rem;
            position: relative;
            margin-bottom: 1.4rem;
        }

        .timeline-dot {
            position: absolute;
            left: 6px;
            top: 0.35rem;
            width: 11px;
            height: 11px;
            border-radius: 999px;
            background: var(--surface);
            border: 3px solid rgba(22, 113, 255, 0.35);
        }

        .timeline-title {
            font-weight: 600;
            color: var(--text);
        }

        .timeline-meta {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 0.35rem;
        }

        .timeline-actions {
            margin-top: 0.75rem;
        }

        .timeline-empty {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Sound Configuration Styles */
        .sound-events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0 2rem 0;
        }

        .sound-event-config {
            background: var(--surface-muted);
            border-radius: 14px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            overflow: hidden; /* Prevent content from spilling out */
        }

        .sound-event-config h3 {
            margin: 0 0 1.25rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sound-event-config h3 svg {
            width: 20px;
            height: 20px;
            color: var(--brand-primary);
        }

        .event-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .control-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .control-row .field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow: hidden; /* Prevent child elements from overflowing */
            min-width: 0; /* Allow flex items to shrink */
        }

        .volume-slider-container {
            overflow: visible; /* Allow the thumb to extend slightly */
            width: 100%;
            box-sizing: border-box;
            padding: 0 4px; /* Add small padding for thumb overflow */
        }

        .current-sound {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--surface);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .current-sound .label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .sound-name {
            font-size: 0.9rem;
            color: var(--text);
            font-weight: 500;
        }

        .sound-library-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .sound-library-section h3 {
            margin: 0 0 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sound-library-section h3 svg {
            width: 20px;
            height: 20px;
            color: var(--brand-primary);
        }

        .sound-library {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            min-height: 120px;
        }

        .library-loading {
            grid-column: 1 / -1;
            text-align: center;
            color: var(--text-muted);
            padding: 2rem;
            font-style: italic;
        }

        .sound-item {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .sound-item:hover {
            border-color: var(--brand-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(22, 113, 255, 0.15);
        }

        .sound-item.selected {
            border-color: var(--brand-primary);
            background: rgba(22, 113, 255, 0.08);
        }

        .sound-item.selected::before {
            content: "";
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 20px;
            height: 20px;
            background: var(--brand-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sound-item.selected::after {
            content: "✓";
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 20px;
            height: 20px;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sound-item-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sound-item-name {
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
        }

        .sound-item-type {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .sound-item-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .sound-item-actions button {
            flex: 1;
            padding: 0.4rem;
            font-size: 0.8rem;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 18px;
            box-shadow: var(--shadow);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(89, 97, 120, 0.1);
        }

        .modal-close svg {
            width: 20px;
            height: 20px;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .upload-area {
            margin-bottom: 1.5rem;
        }

        .upload-placeholder {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .upload-placeholder:hover {
            border-color: var(--brand-primary);
        }

        .upload-placeholder.dragover {
            border-color: var(--brand-primary);
            background: rgba(22, 113, 255, 0.05);
        }

        .upload-placeholder svg {
            width: 40px;
            height: 40px;
            margin-bottom: 1rem;
            color: var(--text-muted);
        }

        .upload-placeholder p {
            margin: 0.5rem 0;
            color: var(--text);
        }

        .upload-hint {
            font-size: 0.85rem;
            color: var(--text-muted) !important;
        }

        .file-preview {
            border: 2px solid var(--brand-primary);
            border-radius: 12px;
            padding: 1rem;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .file-info svg {
            width: 24px;
            height: 24px;
            color: var(--brand-primary);
        }

        .file-details .file-name {
            font-weight: 600;
            color: var(--text);
        }

        .file-details .file-size {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .upload-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(89, 97, 120, 0.3);
            transition: 0.3s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--brand-primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .volume-slider {
            width: 100%;
            max-width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(89, 97, 120, 0.3);
            outline: none;
            -webkit-appearance: none;
            box-sizing: border-box;
            cursor: pointer;
            position: relative;
        }

        /* Force Chromium browsers to show the track */
        .volume-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: rgba(89, 97, 120, 0.3);
            border-radius: 3px;
        }

        .volume-slider::-webkit-slider-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: rgba(89, 97, 120, 0.3);
            border-radius: 3px;
        }

        .volume-slider::-moz-range-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: rgba(89, 97, 120, 0.3);
            border-radius: 3px;
            border: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--brand-primary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
            border: 3px solid white;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: -6px; /* Center thumb on track */
            z-index: 2; /* Ensure thumb is above the pseudo-element */
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.35);
        }

        .volume-slider::-webkit-slider-thumb:active {
            transform: scale(0.95);
        }

        .volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--brand-primary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
            border: 3px solid white;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            z-index: 2; /* Ensure thumb is above elements */
        }

        .volume-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.35);
        }

        .volume-slider::-moz-range-thumb:active {
            transform: scale(0.95);
        }

        .test-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 880px) {
            .page {
                padding: 2.8rem 1.25rem 2.5rem;
            }
        }

        @media (max-width: 720px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            thead {
                display: none;
            }
            table tr {
                display: block;
                padding: 1rem;
            }
            table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border: none;
                border-top: 1px solid rgba(216, 222, 236, 0.45);
            }
            table td::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--text-muted);
                margin-right: 1.25rem;
            }
            table td:first-of-type {
                border-top: none;
            }
            table td input {
                max-width: 60%;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <header class="page-header">
            <div>
                <h1>Pausenverwaltung</h1>
                <p class="subtitle">Verwalten Sie Pausenzeiten und behalten Sie Änderungen im Blick.</p>
            </div>
            <span class="api-badge">API v{{ api_version }}</span>
        </header>

        <main class="layout">
            <section class="panel">
                <h2>Neue Pause anlegen</h2>
                <form id="create-form">
                    <div class="form-grid">
                        <label class="field">
                            Start
                            <input type="time" id="create-start" required>
                        </label>
                        <label class="field">
                            Ende
                            <input type="time" id="create-end" required>
                        </label>
                        <label class="field" style="grid-column: span 2;">
                            Beschreibung
                            <input type="text" id="create-description" placeholder="z. B. Schichtwechsel">
                        </label>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 3V17M3 10H17" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                                </svg>
                                Pause anlegen
                            </button>
                        </div>
                    </div>
                </form>
                <div class="message-area" id="message"></div>
            </section>

            <section class="panel">
                <div class="table-header">
                    <h2>Aktive Pausen</h2>
                    <span id="last-updated" class="status-line"></span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Start</th>
                                <th>Ende</th>
                                <th>Beschreibung</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="breaks-body"></tbody>
                    </table>
                </div>
            </section>

            <section class="panel">
                <div class="table-header">
                    <h2>Sound-Konfiguration</h2>
                    <button type="button" class="btn btn-primary" id="upload-new-sound-btn">
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 3V17M3 10H17" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                        </svg>
                        Neuen Sound hochladen
                    </button>
                </div>

                <!-- Sound Events Configuration -->
                <div class="sound-events-grid">
                    <div class="sound-event-config" data-sound-type="break_start">
                        <h3>
                            <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 3L3 7V13L10 17L17 13V7L10 3Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Pause beginnen
                        </h3>
                        <div class="event-controls">
                            <div class="control-row">
                                <div class="field">
                                    <label>Aktiviert</label>
                                    <div class="toggle-switch">
                                        <input type="checkbox" id="break_start_enabled" checked>
                                        <span class="toggle-slider"></span>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Lautstärke: <span id="break_start_volume_label">50%</span></label>
                                    <div class="volume-slider-container">
                                        <input type="range" id="break_start_volume" min="0" max="100" value="50" class="volume-slider">
                                    </div>
                                </div>
                            </div>
                            <div class="current-sound">
                                <span class="label">Aktueller Sound:</span>
                                <span class="sound-name" id="break_start_current_sound">Standard Sound</span>
                                <button type="button" class="btn btn-primary test-btn" data-sound="break_start">
                                    <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M5 10L7 12L13 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Testen
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="sound-event-config" data-sound-type="break_end">
                        <h3>
                            <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17 7L10 13L3 7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Pause beenden
                        </h3>
                        <div class="event-controls">
                            <div class="control-row">
                                <div class="field">
                                    <label>Aktiviert</label>
                                    <div class="toggle-switch">
                                        <input type="checkbox" id="break_end_enabled" checked>
                                        <span class="toggle-slider"></span>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Lautstärke: <span id="break_end_volume_label">50%</span></label>
                                    <div class="volume-slider-container">
                                        <input type="range" id="break_end_volume" min="0" max="100" value="50" class="volume-slider">
                                    </div>
                                </div>
                            </div>
                            <div class="current-sound">
                                <span class="label">Aktueller Sound:</span>
                                <span class="sound-name" id="break_end_current_sound">Standard Sound</span>
                                <button type="button" class="btn btn-primary test-btn" data-sound="break_end">
                                    <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M5 10L7 12L13 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Testen
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sound Library -->
                <div class="sound-library-section">
                    <h3>
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 12H1M9 12L3 6M9 12L15 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Sound-Bibliothek
                    </h3>
                    <div class="sound-library" id="sound-library">
                        <div class="library-loading">Lade Sounds...</div>
                    </div>
                </div>

                <div class="message-area" id="sound-message"></div>
            </section>

            <!-- Upload Modal -->
            <div class="modal" id="upload-modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Sound hochladen</h3>
                        <button type="button" class="modal-close" id="close-upload-modal">
                            <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 6L14 14M14 6L6 14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="upload-area" id="upload-area">
                            <input type="file" id="sound-file-input" accept=".mp3,.wav" style="display: none;">
                            <div class="upload-placeholder">
                                <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7 10H13M7 10L10 13M7 10L10 7M13 10L10 7M13 10L10 13" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <p>Datei hier ablegen oder klicken zum Auswählen</p>
                                <p class="upload-hint">MP3 oder WAV, max. 10MB</p>
                            </div>
                            <div class="file-preview" id="file-preview" style="display: none;">
                                <div class="file-info">
                                    <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M9 19C6.79 19 5 17.21 5 15C5 12.79 6.79 11 9 11C9.5 11 9.97 11.09 10.41 11.26C10.78 8.24 13.41 6 16.5 6C19.81 6 22.5 8.69 22.5 12C22.5 12.34 22.47 12.67 22.42 13H22.5C24.43 13 26 14.57 26 16.5C26 18.43 24.43 20 22.5 20H9Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <div class="file-details">
                                        <div class="file-name" id="selected-file-name"></div>
                                        <div class="file-size" id="selected-file-size"></div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-danger" id="remove-file-btn">Entfernen</button>
                            </div>
                        </div>
                        <div class="upload-actions">
                            <button type="button" class="btn btn-muted" id="cancel-upload-btn">Abbrechen</button>
                            <button type="button" class="btn btn-primary" id="confirm-upload-btn" disabled>
                                <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 3V17M3 10H17" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                                </svg>
                                Hochladen
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <section class="panel revisions-panel" id="revisions-panel" hidden>
                <div class="revisions-header">
                    <div>
                        <h2>Änderungshistorie</h2>
                        <p class="revisions-meta" id="revision-title"></p>
                    </div>
                    <button class="btn btn-muted" id="revisions-close">
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 6L14 14M14 6L6 14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                        </svg>
                        Schließen
                    </button>
                </div>
                <ol class="timeline" id="revision-log"></ol>
            </section>
        </main>
    </div>

    <script>
        const messageEl = document.getElementById("message");
        const breaksBody = document.getElementById("breaks-body");
        const revisionsPanel = document.getElementById("revisions-panel");
        const revisionTitle = document.getElementById("revision-title");
        const revisionLog = document.getElementById("revision-log");
        const lastUpdatedEl = document.getElementById("last-updated");
        const revisionsCloseBtn = document.getElementById("revisions-close");
        const createForm = document.getElementById("create-form");
        const createStartInput = document.getElementById("create-start");
        const createEndInput = document.getElementById("create-end");

        // Sound configuration elements
        const soundMessageEl = document.getElementById("sound-message");

        let lastLoadedAt = null;
        let allBreaks = [];
        let activeHighlightTimer = null;

        async function apiRequest(path, options = {}) {
            const response = await fetch(path, {
                headers: {
                    "Content-Type": "application/json",
                },
                ...options,
            });
            let data = null;
            try {
                data = await response.json();
            } catch {
                // ignore JSON parse errors for empty bodies
            }
            if (!response.ok) {
                const message = data && data.error ? data.error : response.statusText;
                throw new Error(message || "Unbekannter Fehler");
            }
            return data;
        }

        function setMessage(text, mode = "success") {
            if (!text) {
                messageEl.innerHTML = "";
                return;
            }

            const alertClass = mode === "error" ? "alert-error" : "alert-success";
            messageEl.innerHTML = `
                <div class="alert ${alertClass}">
                    <span>${text}</span>
                    <button type="button" aria-label="Hinweis ausblenden">&times;</button>
                </div>
            `;
            const closeBtn = messageEl.querySelector("button");
            closeBtn?.addEventListener("click", () => (messageEl.innerHTML = ""));
            setTimeout(() => {
                if (closeBtn && messageEl.contains(closeBtn)) {
                    messageEl.innerHTML = "";
                }
            }, 5000);
        }

        function formatTimestamp(date) {
            return date.toLocaleString("de-DE", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
            });
        }

        function timeToMinutes(value) {
            if (!value) return 0;
            const [hours, minutes] = value.split(":").map(Number);
            return hours * 60 + minutes;
        }

        function updateLastUpdated() {
            if (!lastLoadedAt) {
                lastUpdatedEl.textContent = "";
                return;
            }
            lastUpdatedEl.textContent = `Zuletzt aktualisiert: ${formatTimestamp(lastLoadedAt)}`;
        }

        function sortBreaks(list) {
            return list.slice().sort((a, b) => (a.start || "").localeCompare(b.start || "", "de"));
        }

        function findActiveBreak(now = new Date()) {
            const currentMinutes = now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60;
            return allBreaks.find((entry) => {
                const start = timeToMinutes(entry.start);
                const end = timeToMinutes(entry.end);
                return currentMinutes >= start && currentMinutes <= end;
            });
        }

        function refreshActiveHighlight() {
            const active = findActiveBreak();
            breaksBody.querySelectorAll("tr").forEach((row) => {
                const id = Number(row.dataset.breakId);
                row.classList.toggle("is-active", Boolean(active && Number(active.id) === id));
            });
        }

        function startActiveHighlightTimer() {
            if (activeHighlightTimer !== null) {
                return;
            }
            activeHighlightTimer = setInterval(refreshActiveHighlight, 30000);
        }

        function validateTimeWindow(start, end, ignoreId = null, { allowIncomplete = false } = {}) {
            if (!start || !end) {
                if (allowIncomplete) {
                    return { valid: false, pending: true };
                }
                return { valid: false, message: "Bitte Start- und Endzeit angeben." };
            }

            const startMinutes = timeToMinutes(start);
            const endMinutes = timeToMinutes(end);

            if (startMinutes >= endMinutes) {
                return { valid: false, message: "Startzeit muss vor der Endzeit liegen." };
            }

            for (const entry of allBreaks) {
                if (ignoreId !== null && Number(entry.id) === Number(ignoreId)) {
                    continue;
                }
                const entryStart = timeToMinutes(entry.start);
                const entryEnd = timeToMinutes(entry.end);
                const overlaps = Math.max(startMinutes, entryStart) < Math.min(endMinutes, entryEnd);
                if (overlaps) {
                    return {
                        valid: false,
                        message: `Überschneidung mit ${entry.start} – ${entry.end}`,
                    };
                }
            }

            return { valid: true };
        }

        function validateRow(row, { allowIncomplete = false } = {}) {
            const startInput = row.querySelector(".start-input");
            const endInput = row.querySelector(".end-input");
            const breakId = Number(row.dataset.breakId);
            const result = validateTimeWindow(
                startInput.value,
                endInput.value,
                breakId,
                { allowIncomplete }
            );

            if (result.valid) {
                startInput.setCustomValidity("");
                endInput.setCustomValidity("");
                row.classList.remove("has-error");
                return true;
            }

            if (result.pending) {
                startInput.setCustomValidity("");
                endInput.setCustomValidity("");
                row.classList.remove("has-error");
                return false;
            }

            const message = result.message || "Zeitfenster ungültig.";
            startInput.setCustomValidity(message);
            endInput.setCustomValidity(message);
            row.classList.add("has-error");
            return false;
        }

        function validateCreate({ allowIncomplete = false } = {}) {
            const result = validateTimeWindow(
                createStartInput.value,
                createEndInput.value,
                null,
                { allowIncomplete }
            );

            if (result.valid) {
                createStartInput.setCustomValidity("");
                createEndInput.setCustomValidity("");
                return true;
            }

            if (result.pending) {
                createStartInput.setCustomValidity("");
                createEndInput.setCustomValidity("");
                return allowIncomplete;
            }

            const message = result.message || "Zeitfenster ungültig.";
            createStartInput.setCustomValidity(message);
            createEndInput.setCustomValidity(message);
            return false;
        }

        function renderBreaks(list) {
            breaksBody.innerHTML = "";
            const sorted = sortBreaks(list);

            if (!sorted.length) {
                const tr = document.createElement("tr");
                const td = document.createElement("td");
                td.colSpan = 4;
                td.textContent = "Keine Pausen angelegt.";
                td.style.textAlign = "center";
                td.style.color = "var(--text-muted)";
                tr.appendChild(td);
                breaksBody.appendChild(tr);
                return;
            }

            const active = findActiveBreak();
            sorted.forEach((item) => {
                const description = item.description || "";
                const isActive = active && Number(active.id) === Number(item.id);
                const row = document.createElement("tr");
                row.dataset.breakId = item.id;
                row.innerHTML = `
                    <td data-label="Start"><input type="time" value="${item.start}" class="start-input" required></td>
                    <td data-label="Ende"><input type="time" value="${item.end}" class="end-input" required></td>
                    <td data-label="Beschreibung"><input type="text" value="${description.replace(/"/g, "&quot;")}" class="description-input" placeholder="optional"></td>
                    <td data-label="Aktionen">
                        <div class="actions">
                            <button data-action="save" class="btn btn-primary" title="Änderungen speichern">
                                <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M5 11.5L8 14.5L15 7.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Speichern
                            </button>
                            <button data-action="delete" class="btn btn-danger" title="Pause löschen">
                                <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M4 5H16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                                    <path d="M8 4.5V3.5C8 2.948 8.448 2.5 9 2.5H11C11.552 2.5 12 2.948 12 3.5V4.5M15.5 5V15C15.5 15.828 14.828 16.5 14 16.5H6C5.172 16.5 4.5 15.828 4.5 15V5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Löschen
                            </button>
                        </div>
                    </td>
                `;
                if (isActive) {
                    row.classList.add("is-active");
                }
                breaksBody.appendChild(row);
                validateRow(row, { allowIncomplete: true });
            });
        }

        async function loadBreaks() {
            try {
                const data = await apiRequest("/api/breaks");
                allBreaks = data.breaks || [];
                renderBreaks(allBreaks);
                refreshActiveHighlight();
                lastLoadedAt = new Date();
                updateLastUpdated();
            } catch (error) {
                setMessage(error.message, "error");
            }
        }

        async function handleCreate(event) {
            event.preventDefault();
            if (!validateCreate()) {
                createStartInput.reportValidity();
                return;
            }

            const start = createStartInput.value;
            const end = createEndInput.value;
            const description = document.getElementById("create-description").value;
            try {
                await apiRequest("/api/breaks", {
                    method: "POST",
                    body: JSON.stringify({ start, end, description }),
                });
                setMessage("Pause angelegt.");
                event.target.reset();
                await loadBreaks();
            } catch (error) {
                setMessage(error.message, "error");
            }
        }

        async function handleRowAction(event) {
            const button = event.target.closest("button");
            if (!button) return;

            const action = button.dataset.action;
            if (!action) return;

            const row = button.closest("tr");
            const breakId = row ? Number(row.dataset.breakId) : null;
            if (!breakId) return;

            if (action === "save") {
                if (!validateRow(row)) {
                    row.querySelector(".start-input")?.reportValidity();
                    return;
                }
                const start = row.querySelector(".start-input").value;
                const end = row.querySelector(".end-input").value;
                const description = row.querySelector(".description-input").value;
                try {
                    await apiRequest(`/api/breaks/${breakId}`, {
                        method: "PUT",
                        body: JSON.stringify({ start, end, description }),
                    });
                    setMessage("Änderung gespeichert.");
                    await loadBreaks();
                } catch (error) {
                    setMessage(error.message, "error");
                }
            } else if (action === "delete") {
                if (!confirm("Pause wirklich entfernen?")) return;
                try {
                    await apiRequest(`/api/breaks/${breakId}`, { method: "DELETE" });
                    setMessage("Pause entfernt.");
                    await loadBreaks();
                } catch (error) {
                    setMessage(error.message, "error");
                }
            } else if (action === "history") {
                await loadRevisions(breakId);
            }
        }

        function renderRevisions(revisions, breakId) {
            revisionLog.innerHTML = "";
            if (!revisions.length) {
                const li = document.createElement("li");
                li.className = "timeline-empty";
                li.textContent = "Keine Änderungen vorhanden.";
                revisionLog.appendChild(li);
                return;
            }

            revisions.forEach((item) => {
                const li = document.createElement("li");
                li.className = "timeline-item";
                li.dataset.revisionId = item.id;
                li.innerHTML = `
                    <span class="timeline-dot"></span>
                    <div class="timeline-title">${item.change_type}</div>
                    <div class="timeline-meta">
                        ${item.start} – ${item.end}
                        ${item.description ? `· ${item.description}` : ""}
                        ${item.changed_by ? ` · ${item.changed_by}` : ""}
                        · ${formatTimestamp(new Date(item.changed_at))}
                    </div>
                    <div class="timeline-actions">
                        <button class="btn btn-primary" data-action="restore" data-revision-id="${item.id}">
                            <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3.5 10.5L5.5 8M5.5 8V13.5M5.5 8H11C13.4853 8 15.5 10.0147 15.5 12.5C15.5 14.9853 13.4853 17 11 17H9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Wiederherstellen
                        </button>
                    </div>
                `;
                revisionLog.appendChild(li);
            });

            revisionTitle.textContent = `Pause #${breakId}`;
            revisionsPanel.hidden = false;
        }

        async function loadRevisions(breakId) {
            try {
                const data = await apiRequest(`/api/breaks/${breakId}/revisions`);
                renderRevisions(data.revisions || [], breakId);
            } catch (error) {
                setMessage(error.message, "error");
            }
        }

        async function restoreRevision(revisionId, breakId) {
            try {
                await apiRequest(`/api/revisions/${revisionId}/restore`, { method: "POST" });
                setMessage("Revision wurde wiederhergestellt.");
                await loadBreaks();
                await loadRevisions(breakId);
            } catch (error) {
                setMessage(error.message, "error");
            }
        }

        // Sound configuration functions
        let soundLibrary = [];
        let currentSoundSettings = {};
        let selectedForAssignment = null; // Which sound event we're assigning a sound to

        function setSoundMessage(text, mode = "success") {
            if (!text) {
                soundMessageEl.innerHTML = "";
                return;
            }

            const alertClass = mode === "error" ? "alert-error" : "alert-success";
            soundMessageEl.innerHTML = `
                <div class="alert ${alertClass}">
                    <span>${text}</span>
                    <button type="button" aria-label="Hinweis ausblenden">&times;</button>
                </div>
            `;
            const closeBtn = soundMessageEl.querySelector("button");
            closeBtn?.addEventListener("click", () => (soundMessageEl.innerHTML = ""));
            setTimeout(() => {
                if (closeBtn && soundMessageEl.contains(closeBtn)) {
                    soundMessageEl.innerHTML = "";
                }
            }, 5000);
        }

        async function loadSoundSettings() {
            try {
                const data = await apiRequest("/api/sounds");
                const sounds = data.sounds || [];

                sounds.forEach(sound => {
                    updateSoundUI(sound.sound_type, sound);
                });

                // Load sound library
                await loadSoundLibrary();
            } catch (error) {
                console.error("Failed to load sound settings:", error);
            }
        }

        async function loadSoundLibrary() {
            try {
                const data = await apiRequest("/api/sounds/library");
                soundLibrary = data.sounds || [];
                currentSoundSettings = data.current_settings || {};
                renderSoundLibrary();
                updateCurrentSoundNames();
            } catch (error) {
                console.error("Failed to load sound library:", error);
                document.getElementById("sound-library").innerHTML =
                    '<div class="library-loading">Fehler beim Laden der Sound-Bibliothek</div>';
            }
        }

        function renderSoundLibrary() {
            const libraryEl = document.getElementById("sound-library");

            if (!soundLibrary.length) {
                libraryEl.innerHTML = '<div class="library-loading">Keine Sounds verfügbar</div>';
                return;
            }

            libraryEl.innerHTML = soundLibrary.map(sound => `
                <div class="sound-item ${getCurrentSoundForType(sound) ? 'selected' : ''}"
                     data-sound-id="${sound.id}"
                     data-file-path="${sound.file_path}">
                    <div class="sound-item-info">
                        <div class="sound-item-name">${sound.name}</div>
                        <div class="sound-item-type">${sound.type === 'default' ? 'Standard' : 'Benutzerdefiniert'}</div>
                    </div>
                    <div class="sound-item-actions">
                        <button class="btn btn-primary assign-btn" onclick="showAssignmentDialog('${sound.file_path}')">
                            Zuweisen
                        </button>
                        <button class="btn btn-muted test-library-btn" onclick="testLibrarySound('${sound.file_path}')">
                            Testen
                        </button>
                        ${sound.type === 'custom' ? `
                            <button class="btn btn-danger delete-btn" onclick="deleteCustomSound('${sound.file_path}')">
                                Löschen
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateSoundUI(soundType, settings) {
            const enabledInput = document.getElementById(`${soundType}_enabled`);
            const volumeSlider = document.getElementById(`${soundType}_volume`);
            const volumeLabel = document.getElementById(`${soundType}_volume_label`);

            if (enabledInput) enabledInput.checked = settings.enabled;
            if (volumeSlider) volumeSlider.value = settings.volume;
            if (volumeLabel) volumeLabel.textContent = `${settings.volume}%`;
            if (volumeSlider) updateVolumeSliderBackground(volumeSlider);
        }

        function updateCurrentSoundNames() {
            const breakStartEl = document.getElementById('break_start_current_sound');
            const breakEndEl = document.getElementById('break_end_current_sound');

            if (breakStartEl && currentSoundSettings.break_start) {
                const sound = soundLibrary.find(s => s.file_path === currentSoundSettings.break_start.file_path);
                if (sound) {
                    breakStartEl.textContent = sound.name;
                } else if (currentSoundSettings.break_start.file_path) {
                    breakStartEl.textContent = currentSoundSettings.break_start.file_path.split('/').pop();
                } else {
                    breakStartEl.textContent = 'Standard Sound';
                }
            }

            if (breakEndEl && currentSoundSettings.break_end) {
                const sound = soundLibrary.find(s => s.file_path === currentSoundSettings.break_end.file_path);
                if (sound) {
                    breakEndEl.textContent = sound.name;
                } else if (currentSoundSettings.break_end.file_path) {
                    breakEndEl.textContent = currentSoundSettings.break_end.file_path.split('/').pop();
                } else {
                    breakEndEl.textContent = 'Standard Sound';
                }
            }
        }

        function getCurrentSoundForType(sound) {
            for (const [soundType, settings] of Object.entries(currentSoundSettings)) {
                if (settings.file_path === sound.file_path) {
                    return soundType;
                }
            }
            return null;
        }

        function showAssignmentDialog(filePath) {
            selectedForAssignment = filePath;

            // Create a simple dialog to choose which event to assign to
            const events = ['break_start', 'break_end'];
            const eventNames = {
                'break_start': 'Pause beginnen',
                'break_end': 'Pause beenden'
            };

            const dialog = document.createElement('div');
            dialog.className = 'modal';
            dialog.style.display = 'flex';
            dialog.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Sound zuweisen</h3>
                        <button type="button" class="modal-close" onclick="closeAssignmentDialog()">
                            <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 6L14 14M14 6L6 14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Welchem Ereignis soll dieser Sound zugewiesen werden?</p>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                            ${events.map(event => `
                                <button class="btn btn-primary" onclick="assignSoundToEvent('${event}')">
                                    ${eventNames[event]}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);
        }

        function closeAssignmentDialog() {
            const dialog = document.querySelector('.modal');
            if (dialog) {
                dialog.remove();
            }
            selectedForAssignment = null;
        }

        async function assignSoundToEvent(soundType) {
            if (!selectedForAssignment) return;

            try {
                await apiRequest("/api/sounds", {
                    method: "POST",
                    body: JSON.stringify({
                        sound_type: soundType,
                        file_path: selectedForAssignment
                    })
                });

                // Update local settings
                currentSoundSettings[soundType].file_path = selectedForAssignment;

                // Update UI
                updateCurrentSoundNames();
                renderSoundLibrary();
                closeAssignmentDialog();
                setSoundMessage("Sound zugewiesen.");
            } catch (error) {
                setSoundMessage(error.message, "error");
            }
        }

        async function testLibrarySound(filePath) {
            try {
                // Directly play the sound file for testing
                const audio = new Audio(`/${filePath}`);
                audio.volume = 0.5; // Default test volume

                audio.play().then(() => {
                    setSoundMessage("Sound wird abgespielt.");
                }).catch(error => {
                    setSoundMessage("Fehler bei der Wiedergabe.", "error");
                });
            } catch (error) {
                setSoundMessage(error.message, "error");
            }
        }

        async function deleteCustomSound(filePath) {
            if (!confirm("Diesen Sound wirklich löschen? Er wird von allen Ereignissen entfernt.")) return;

            try {
                // Remove from all events using this sound
                for (const [soundType, settings] of Object.entries(currentSoundSettings)) {
                    if (settings.file_path === filePath) {
                        await apiRequest("/api/sounds", {
                            method: "POST",
                            body: JSON.stringify({
                                sound_type: soundType,
                                file_path: ""
                            })
                        });
                        currentSoundSettings[soundType].file_path = '';
                    }
                }

                // Delete the file from server (would need additional endpoint)
                await apiRequest(`/api/sounds/delete`, {
                    method: "DELETE",
                    body: JSON.stringify({ file_path: filePath })
                });

                await loadSoundLibrary(); // Reload the library
                setSoundMessage("Sound gelöscht.");
            } catch (error) {
                setSoundMessage(error.message, "error");
            }
        }

        function updateVolumeSliderBackground(slider) {
            const value = (slider.value / slider.max) * 100;
            slider.style.setProperty('--value', `${value}%`);
        }

        async function handleSoundToggle(event) {
            const soundType = event.target.id.replace('_enabled', '');
            const enabled = event.target.checked;

            try {
                await apiRequest("/api/sounds", {
                    method: "POST",
                    body: JSON.stringify({
                        sound_type: soundType,
                        enabled: enabled
                    })
                });
                setSoundMessage(enabled ? "Sound aktiviert." : "Sound deaktiviert.");
            } catch (error) {
                setSoundMessage(error.message, "error");
                // Revert UI state on error
                event.target.checked = !enabled;
            }
        }

        async function handleVolumeChange(event) {
            const soundType = event.target.id.replace('_volume', '');
            const volume = parseInt(event.target.value);
            const volumeLabel = document.getElementById(`${soundType}_volume_label`);

            if (volumeLabel) volumeLabel.textContent = `${volume}%`;
            updateVolumeSliderBackground(event.target);

            try {
                await apiRequest("/api/sounds", {
                    method: "POST",
                    body: JSON.stringify({
                        sound_type: soundType,
                        volume: volume
                    })
                });
            } catch (error) {
                console.error("Failed to update volume:", error);
            }
        }

        async function handleSoundTest(event) {
            const button = event.target.closest("button");
            const soundType = button.dataset.sound;

            // Disable button during test
            button.disabled = true;
            const originalContent = button.innerHTML;
            button.innerHTML = `
                <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 3V10M10 13V17M3 10H7M13 10H17" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                </svg>
                Teste...
            `;

            try {
                const result = await apiRequest("/api/sounds/test", {
                    method: "POST",
                    body: JSON.stringify({ sound_type: soundType })
                });

                // Create audio element for testing
                const audio = new Audio(`/${result.file_path}`);
                audio.volume = result.volume / 100;

                audio.play().then(() => {
                    setSoundMessage("Sound wird abgespielt.");
                }).catch((error) => {
                    setSoundMessage("Fehler bei der Wiedergabe.", "error");
                }).finally(() => {
                    // Restore button
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = originalContent;
                    }, 1000);
                });

            } catch (error) {
                setSoundMessage(error.message, "error");
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }

        // Upload Modal Functions
        function showUploadModal() {
            document.getElementById('upload-modal').style.display = 'flex';
        }

        function hideUploadModal() {
            document.getElementById('upload-modal').style.display = 'none';
            resetUploadForm();
        }

        function resetUploadForm() {
            const fileInput = document.getElementById('sound-file-input');
            const placeholderEl = document.getElementById('upload-placeholder');
            const previewEl = document.getElementById('file-preview');
            const confirmBtn = document.getElementById('confirm-upload-btn');

            if (fileInput) fileInput.value = '';
            if (placeholderEl) placeholderEl.style.display = 'block';
            if (previewEl) previewEl.style.display = 'none';
            if (confirmBtn) confirmBtn.disabled = true;
        }

        function handleFileSelect(file) {
            if (!file) return;

            // Validate file
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/mp3'];
            const maxSize = 10 * 1024 * 1024; // 10MB

            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(mp3|wav)$/i)) {
                setSoundMessage("Nur MP3 und WAV Dateien sind erlaubt.", "error");
                return;
            }

            if (file.size > maxSize) {
                setSoundMessage("Die Datei ist größer als 10MB.", "error");
                return;
            }

            // Show file preview - Check if elements exist first
            const nameEl = document.getElementById('selected-file-name');
            const sizeEl = document.getElementById('selected-file-size');
            const placeholderEl = document.getElementById('upload-placeholder');
            const previewEl = document.getElementById('file-preview');
            const confirmBtn = document.getElementById('confirm-upload-btn');

            if (nameEl) nameEl.textContent = file.name;
            if (sizeEl) sizeEl.textContent = formatFileSize(file.size);
            if (placeholderEl) placeholderEl.style.display = 'none';
            if (previewEl) previewEl.style.display = 'block';
            if (confirmBtn) confirmBtn.disabled = false;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function handleFileUpload() {
            const fileInput = document.getElementById('sound-file-input');
            const file = fileInput.files[0];

            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('sound_type', 'custom'); // Generic type for library

            try {
                const response = await fetch('/api/sounds/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Upload failed');
                }

                const result = await response.json();
                setSoundMessage("Sound erfolgreich hochgeladen.");
                hideUploadModal();
                await loadSoundLibrary(); // Refresh library
            } catch (error) {
                setSoundMessage(error.message, "error");
            }
        }

        function attachEventListeners() {
            createForm.addEventListener("submit", handleCreate);
            createForm.addEventListener("input", () => validateCreate({ allowIncomplete: true }));
            breaksBody.addEventListener("click", handleRowAction);
            breaksBody.addEventListener("input", (event) => {
                const row = event.target.closest("tr");
                if (!row) return;
                validateRow(row, { allowIncomplete: true });
            });
            revisionLog.addEventListener("click", async (event) => {
                const button = event.target.closest("button");
                if (!button || button.dataset.action !== "restore") return;
                const revisionId = Number(button.dataset.revisionId);
                const breakId = Number(revisionTitle.textContent.replace(/\D+/g, ""));
                if (!revisionId || !breakId) return;
                await restoreRevision(revisionId, breakId);
            });
            revisionsCloseBtn.addEventListener("click", () => {
                revisionsPanel.hidden = true;
                revisionLog.innerHTML = "";
            });

            // Sound configuration event listeners
            document.querySelectorAll('[id$="_enabled"]').forEach(input => {
                input.addEventListener("change", handleSoundToggle);
            });

            document.querySelectorAll('.volume-slider').forEach(slider => {
                slider.addEventListener("input", handleVolumeChange);
                updateVolumeSliderBackground(slider);
            });

            document.querySelectorAll('.test-btn').forEach(button => {
                button.addEventListener("click", handleSoundTest);
            });

            // Upload modal event listeners - Check if elements exist first
            const uploadBtn = document.getElementById('upload-new-sound-btn');
            const closeBtn = document.getElementById('close-upload-modal');
            const cancelBtn = document.getElementById('cancel-upload-btn');
            const confirmBtn = document.getElementById('confirm-upload-btn');
            const removeBtn = document.getElementById('remove-file-btn');

            if (uploadBtn) uploadBtn.addEventListener('click', showUploadModal);
            if (closeBtn) closeBtn.addEventListener('click', hideUploadModal);
            if (cancelBtn) cancelBtn.addEventListener('click', hideUploadModal);
            if (confirmBtn) confirmBtn.addEventListener('click', handleFileUpload);
            if (removeBtn) removeBtn.addEventListener('click', resetUploadForm);

            // File upload area events
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('sound-file-input');

            if (uploadArea && fileInput) {
                uploadArea.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) handleFileSelect(file);
                });

                // Drag and drop events
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const placeholder = uploadArea.querySelector('.upload-placeholder');
                    if (placeholder) placeholder.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    const placeholder = uploadArea.querySelector('.upload-placeholder');
                    if (placeholder) placeholder.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const placeholder = uploadArea.querySelector('.upload-placeholder');
                    if (placeholder) placeholder.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFileSelect(files[0]);
                    }
                });
            }

            // Close modal on background click
            const modal = document.getElementById('upload-modal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target.id === 'upload-modal') {
                        hideUploadModal();
                    }
                });
            }
        }

        attachEventListeners();
        loadBreaks();
        loadSoundSettings();
        startActiveHighlightTimer();
    </script>
</body>
</html>
